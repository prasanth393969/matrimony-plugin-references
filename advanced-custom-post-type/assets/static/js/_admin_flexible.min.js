import{dateFields,useTranslation}from"./_admin_commons.min.js";import{initSortable}from"./_admin_sortable.min.js";import{initColorPicker}from"./_admin_colorpicker.min.js";import{initDateRangePicker}from"./_admin_datepicker.min.js";import{initRelationalFields}from"./_admin_relational.min.js";import{initTinyMCE}from"./_admin_editor.min.js";import{initBarcode,initCodeMirror,initCountrySelect,initEmbed,initIdGenerators,initImageSlider,initIntlTelInput,initQRCodeGenerator,initSelectize,initTextarea,initValidator}from"./_admin_misc.min.js";var $=jQuery.noConflict();let handleFlexibleFieldsEvents=()=>{$("body").on("click",".acpt_add_flexible_btn",function(t){t.preventDefault();var t=$(this),e=t.next(".acpt_flexible_block_items");t.hasClass("active")?t.removeClass("active"):t.addClass("active"),e.hasClass("active")?e.removeClass("active"):e.addClass("active")}),document.addEventListener("click",function(t){t=t.target;!1===(t.classList.contains("acpt_flexible_block_item")||t.classList.contains("acpt_add_flexible_btn")||t.classList.contains("acpt_add_flexible_btn_label")||t.classList.contains("acpt_add_flexible_btn_icon")||t.classList.contains("acpt_add_flexible_btn_icon")||t.parentNode.classList.contains("acpt_add_flexible_btn_icon"))&&($(".acpt_flexible_block_items").removeClass("active"),$(".acpt_add_flexible_btn").removeClass("active"))}),$("body").on("click",".remove-all-blocks",function(t){t.preventDefault();var e,t=$(this),a=t.data("block-list-id"),i=$("ul#acpt-sortable-"+a),n=(t.data("min-blocks"),t.data("max-blocks")),t=t.prev().prev();i&&(i.empty(),e=useTranslation('No blocks saved, generate the first one clicking on "Add block" button'),i.append(`<p data-message-id="${a}" class="update-nag notice notice-warning inline no-records">${e}</p>`),n)&&0<n&&t.attr("disabled",!1)}),$("body").on("click",".acpt_flexible_block_items > li",function(t){t.preventDefault();var t=$(this),e=t.parent(),a=t.data("layout"),i=t.data("value"),n=t.data("block-list-id"),l=t.data("parent-name"),d=(t.data("block-index"),t.data("media-type")),c=t.data("field-id"),o=t.data("min-blocks");let s=t.data("max-blocks"),r=$("ul#acpt-sortable-"+n),p=r.find("li.acpt_blocks_list_item").length,f=r.next(".acpt_add_flexible_block").find("button"),b=$('[data-message-id="'+c+'"]');(void 0===s||""===s||p<s)&&$.ajax({type:"POST",url:ajaxurl,data:{action:"generateFlexibleBlockAction",data:JSON.stringify({layout:a,blockId:i,mediaType:d,parentName:l,index:p,blockListId:n,minBlocks:o,maxBlocks:s})},success:function(t){if(r){r.append(t.block);{t=r.find("li").last(),t=(0<t.length&&t[0].scrollIntoView({behavior:"smooth"}),void 0===s||""===s||p+1>=s||f.attr("disabled",!0),initSortable(),initValidator(),b&&b.remove(),r.last().find(".acpt-relation-field-selector")),t=(t.each(function(){initRelationalFields($(this).attr("id"))}),dateFields.map(t=>{r.last().find(t.selector).each(function(){initDateRangePicker(t.format,$(this).attr("id"))})}),r.last().find("textarea.acpt-codemirror"));t.each(function(){initCodeMirror($(this).attr("id"))})}r.last().find(".acpt-color-picker").each(function(){initColorPicker($(this).attr("id"))}),r.last().find("select.acpt-select2").each(function(){initSelectize($(this).attr("id"))}),r.last().find("textarea.acpt-wp-editor").each(function(){var t=$(this).attr("id"),e=$(this).attr("rows"),a=$(this).data("toolbar");initTinyMCE(t,e,a)}),r.last().find("input.acpt-id-value").each(function(){initIdGenerators($(this).attr("id"),!0)}),r.last().find("input.acpt-phone").each(function(){initIntlTelInput($(this).attr("id"))}),r.last().find("input.acpt-country").each(function(){initCountrySelect($(this).attr("id"))}),r.last().find(".acpt-qr-code-wrapper").each(function(){initQRCodeGenerator($(this).attr("id"))}),r.last().find(".acpt-barcode-wrapper").each(function(){initBarcode($(this).attr("id"))}),r.last().find(".acpt-image-slider").each(function(){initImageSlider($(this).attr("id"))}),r.last().find(".acpt-embed").each(function(){initEmbed($(this).attr("id"))}),r.last().find(".acpt-textarea").each(function(){initTextarea($(this).attr("id"))})}},dataType:"json"}),e.removeClass("active")}),$("body").on("click",".acpt_delete_all_flexible_element_btn",function(t){t.preventDefault();var t=$(this),e=t.data("block-id"),a=t.data("group-id"),i=t.data("element"),n=t.data("layout"),t=t.data("index"),e=($('[data-parent-id="'+e+'"]'),$(`#block-elements-${a}-`+t)),a=`block-elements-${a}-`+t;e&&(t=`<p data-message-id="${a}" class="update-nag notice notice-warning inline no-records">${useTranslation(`No fields saved, generate the first one clicking on "Add ${i}" button`)}</p>`,"table"===n?(i=e.find("tr").children.length,e.children("tr").each(function(t,e){0<t&&e.remove()}),n=i+2,$("#"+a).append(`<tr><td colspan="${n}">${t}</td></tr>`)):(e.empty(),$("#"+a).html("").append(t)))}),document.addEventListener("keydown",t=>{if(t.ctrlKey&&"Enter"===t.key&&t.target.classList.contains("acpt-admin-meta-field-input")){t.stopPropagation(),t.preventDefault();t=$(t.target);let e=t.closest("table");if(0<(e=0===e.length?t.closest("ul"):e).length){let t=e.parent().next(".acpt_add_flexible_element_btn");0<(t=0===(t=0===t.length?e.parent().parent().next(".acpt_add_flexible_element_btn"):t).length?e.parent().parent().parent().parent().parent().next(".acpt_add_flexible_element_btn"):t).length&&t.click()}}}),$("body").on("click",".acpt_add_flexible_element_btn",function(t){t.preventDefault();var t=$(this),e=t.data("block-id");let a=t.data("layout");var i=t.data("group-id"),n=t.data("media-type"),l=t.data("parent-name"),d=t.data("index"),c=t.data("min-blocks"),t=t.data("max-blocks"),e=$('[data-parent-id="'+e+'"]');let o=e.find(`#block-elements-${i}-`+d),s=e.find('[data-message-id="block-elements-'+i+"-"+d+'"]');$.ajax({type:"POST",url:ajaxurl,data:{action:"generateFlexibleGroupedFieldsAction",data:JSON.stringify({blockId:i,mediaType:n,elementIndex:(e=a,i=o,"table"===e?1==(e=i.find("tr").length-1)&&1===i.find("tr").find("td").length?0:e:i.find("li").length),blockIndex:d,layout:a,parentName:l,minBlocks:c,maxBlocks:t})},success:function(e){if(o){o.append(e.fields),initSortable(),initValidator();let t=o.find("li").last();0===t.length&&(t=o.find("tr").last()),0<(e=t).length&&(e[0].scrollIntoView({behavior:"smooth"}),e.addClass("sortable-li-active"),e.find(".acpt-admin-meta-field-input").each(function(t,e){var a=$(this),i=a.prop("tagName");if("INPUT"===i&&"hidden"!==a.attr("type"))return a.focus(),!1}));{e=new Event("acpt_flexible_element_added"),e=(document.dispatchEvent(e),s&&("table"===a?s.parent("td").parent("tr"):s).remove(),o.last().find(".acpt-relation-field-selector")),e=(e.each(function(){initRelationalFields($(this).attr("id"))}),dateFields.map(t=>{o.last().find(t.selector).each(function(){initDateRangePicker(t.format,$(this).attr("id"))})}),o.last().find("textarea.acpt-codemirror"));e.each(function(){initCodeMirror($(this).attr("id"))})}o.last().find(".acpt-color-picker").each(function(){initColorPicker($(this).attr("id"))}),o.last().find("select.acpt-select2").each(function(){initSelectize($(this).attr("id"))}),o.last().find("textarea.acpt-wp-editor").each(function(){var t=$(this).attr("id"),e=$(this).attr("rows"),a=$(this).data("toolbar");initTinyMCE(t,e,a)}),o.last().find("input.acpt-id-value").each(function(){initIdGenerators($(this).attr("id"),!0)}),o.last().find("input.acpt-phone").each(function(){initIntlTelInput($(this).attr("id"))}),o.last().find("input.acpt-country").each(function(){initCountrySelect($(this).attr("id"))}),o.last().find(".acpt-qr-code-wrapper").each(function(){initQRCodeGenerator($(this).attr("id"))}),o.last().find(".acpt-barcode-wrapper").each(function(){initBarcode($(this).attr("id"))}),o.last().find(".acpt-image-slider").each(function(){initImageSlider($(this).attr("id"))}),o.last().find(".acpt-embed").each(function(){initEmbed($(this).attr("id"))}),o.last().find(".acpt-textarea").each(function(){initTextarea($(this).attr("id"))})}},dataType:"json"})}),$("body").on("click",".acpt_blocks_list_item_toggle_visibility",function(t){t.preventDefault();var t=$(this),e=t.data("target-id"),a=$("#"+e),e=($("*[data-parent-id="+e+"]"),$("*[data-block-id="+e+"]"),t.parent().parent(),t.hasClass("reverse")?t.removeClass("reverse"):t.addClass("reverse"),a.hasClass("collapsed")?a.removeClass("collapsed"):a.addClass("collapsed"),new Event("acpt_grouped_element_toggle_visibilty"));document.dispatchEvent(e)}),$("body").on("click",".acpt_blocks_list_item_delete",function(t){t.preventDefault();var t=$(this).data("target-id"),t=$("#"+t),e=t.parent(),a=e.attr("id");let i=e.find("li.acpt_blocks_list_item").length;e.data("min-blocks");let n=e.data("max-blocks");var l=e.next(".acpt_add_flexible_block").find("button");(void 0===n||""===n||i>=n)&&l.attr("disabled",!1),t.remove(),1===i&&(l=useTranslation('No blocks saved, generate the first one clicking on "Add block" button'),e.append(`<p data-message-id="${a}" class="update-nag notice notice-warning inline no-records">${l}</p>`))})};export{handleFlexibleFieldsEvents};