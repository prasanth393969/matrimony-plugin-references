import{$$,debounce,removeCookie,setCookie}from"./_admin_commons.min.js";var $=jQuery.noConflict();let runMiscFunctions=()=>{$(".acpt-metabox .toggle-indicator").on("click",function(){var e,t,a=$(this);0<a.closest(".acpt-metabox").length&&(e=(e=>{let t="";var a;for(a of e.classList.values())"closed"!==a&&(t+=a+"_");return t+"closed"})(a=a.closest(".acpt-metabox")[0]),t=window.location.hostname,a.classList.contains("closed")?removeCookie(e,"/",t):setCookie(e,"1",30,{path:"/",domain:t,SameSite:"none",Secure:!0}))}),$(".acpt-toggle-indicator").on("click",function(){var e=$(this).data("target");$("#"+e).toggleClass("closed")}),$(".acpt-range").on("change",function(){var e=$(this).attr("id"),t=$(this).val();$(`#${e}_value`).text(t)}),$("#commentform").length&&($("#commentform")[0].encoding="multipart/form-data");$("#addtag").on("mousedown","#submit",function(){(()=>{let e=["attachment_id","city","country","currency","dial","forged_by","label","lat","length","lng","weight"];["image-preview","file-preview","preview-file","acpt_map_preview","acpt_map_multi_preview","embed-preview"].forEach(function(e){$("#addtag ."+e).html("")}),$("#addtag").find("input").each(function(){let t=$(this),a=t.attr("name");a&&e.forEach(function(e){1==a.endsWith("_"+e)&&t.val("")})})})(),"undefined"!=typeof tinyMCE&&(tinyMCE.triggerSave(),$(document).bind("ajaxSuccess.vtde_add_term",function(){tinyMCE.activeEditor&&tinyMCE.activeEditor.setContent(""),$(document).unbind("ajaxSuccess.vtde_add_term",!1)}))}),$(".wppd-ui-toggle").on("change",function(){var e=$(this).attr("id");$("#"+e).val($(this).is(":checked")?1:0)}),$(".currency-selector").on("change",function(){var e=$(this).find("option:selected"),t=$(this).parent("div").prev();t.prev().text(e.data("symbol")),t.prop("placeholder",e.data("placeholder"))}),$(".acpt-reset-map").on("click",function(e){e.preventDefault();var e=$(this).parent();let i;e.find("input").each(function(){var e=$(this),t=e.attr("id"),a=e.attr("type");t&&("text"===a&&(i=t),e.val(""))}),i&&(e=new CustomEvent("acpt-reset-map",{detail:{fieldId:i+"_map"}}),document.dispatchEvent(e))}),$(".acpt-admin-horizontal-tab").on("click",function(e){e.preventDefault();var e=$(this),t=e.parent(),a=e.data("target"),i=$("#"+a).parent();t.children().removeClass("active"),i.children().removeClass("active"),$("#"+a).addClass("active"),e.addClass("active")}),$(".acpt-admin-vertical-tab").on("click",function(e){e.preventDefault();var e=$(this),t=e.parent(),a=e.data("target"),i=$("#"+a).parent();t.children().removeClass("active"),i.children().removeClass("active"),$("#"+a).addClass("active"),e.addClass("active")}),$(".acpt-admin-accordion-title").on("click",function(e){e.preventDefault();var e=$(this).parent("div"),t=e.parent("div"),a=e.hasClass("active");t.children().each(function(){$(this).removeClass("active")}),a?e.removeClass("active"):e.addClass("active")})},initCodeMirror=(t=null)=>{try{let e=t?"#"+t:"textarea.acpt-codemirror";$$(e).length&&$$(e).each(function(){let t="#"+$(this).attr("id");if("undefined"!=typeof wp){var a=wp.codeEditor.defaultSettings?_.clone(wp.codeEditor.defaultSettings):{};a.codemirror=_.extend({},a.codemirror,{lineNumbers:!0,indentUnit:2,tabSize:2,mode:"htmlmixed"});let e=wp.codeEditor.initialize($$(t),a);$(document).on("keyup",".CodeMirror-code",function(){$(t).html(e.codemirror.getValue()),$(t).trigger("change")})}else"function"==typeof CodeMirror&&CodeMirror.fromTextArea(document.getElementById($(this).attr("id")),{lineNumbers:!0,indentUnit:2,tabSize:2,mode:"htmlmixed"})})}catch(e){console.error(e)}},initSelectize=(f=null)=>{try{if(jQuery().selectize){let v=(e,t)=>{var a,i,n="<--------\x3e";return e.text.includes(n)?(a=(n=e.text.split(n))[0],i=n[2],`<div class="selectize-item">${a?`<div class="selectize-thumbnail"><img src="${a}" alt="${i}" width="40" /></div>`:'<div class="selectize-thumbnail"><span class="selectize-thumbnail-no-image"></span></div>'}<div class="selectize-details"><span class='acpt-badge'>${n[1]}</span><span>${i}</span></div></div>`):e.image?`<div class="selectize-item"><img src="${e.image}" alt="fdfd" width="50" /><div class="selectize-details"><span>${e.text}</span></div></div>`:`<div>${e.text}</div>`},e=".acpt-select2";f&&(e="#"+f),$$(e).get().forEach(e=>{let i=$(e);if(!i.hasClass("selectized")){let a=(e=null)=>{var t={plugins:["restore_on_backspace","clear_button","remove_button"],placeholder:"--Select--",onChange:function(){this.$input[0].dispatchEvent(new Event("change"))},render:{option:function(e,t){return v(e)},item:function(e,t){return v(e)}}};e&&(t[maxItems]=e),i.selectize(t),i.siblings(".acpt-placeholder").remove()};if(i.hasClass("acpt-select2-ajax")){var e=i.data("field-type"),n=i.data("to-type"),l=i.data("to-value"),o=i.data("post-type"),r=i.data("post-status"),c=i.data("post-taxonomy"),d=i.data("term-taxonomy"),s=i.data("user-role"),p=i.data("default-values"),u=i.data("layout");i.data("min");let t=i.data("max");$.ajax({type:"POST",url:ajaxurl,data:{action:"generateRelationalFieldOptionsAction",data:JSON.stringify({id:f,fieldType:e,toType:n,toValue:l,postType:o,postStatus:r,postTaxonomy:c,termTaxonomy:d,userRole:s,defaultValues:p,layout:u,format:"data"})},success:function(e){e.fields&&e.fields.map(e=>{var a=e.label;if(e.value)i.append($("<option>",{value:e.value,text:e.label,selected:e.selected}));else if(e.options){let t=$("<optgroup>",{label:a});e.options.map(e=>{t.append($("<option>",{value:e.value,text:e.label,selected:e.selected}))}),i.append(t)}}),a(t)},dataType:"json"})}else a()}})}}catch(e){console.error(e)}},initIntlTelInput=(t=null)=>{try{let e=".acpt-phone";t&&(e="#"+t),$$(e).get().forEach(t=>{if("undefined"!=typeof intlTelInput&&void 0!==t){let a=t.previousSibling,i=a.previousSibling,e=i.previousSibling,n=intlTelInput(t,{initialCountry:a.value,separateDialCode:!0,geoIpLookup:t=>{fetch("https://ipapi.co/json").then(e=>e.json()).then(e=>t(e.country_code)).catch(()=>t("us"))},loadUtils:()=>import(e.value)});t.addEventListener("countrychange",function(e){var t=n.getSelectedCountryData();t.iso2&&t.dialCode&&(a.value=t.iso2,i.value=t.dialCode)})}})}catch(e){console.error(e)}},initCountrySelect=(t=null)=>{try{let e=".acpt-country",i=(t&&(e="#"+t),$$(e));if(i.length){let a=i.prev();i.countrySelect({defaultCountry:a.val(),preferredCountries:[]}),i.on("change",e=>{var t=i.countrySelect("getSelectedCountryData");a.val(t.iso2)})}}catch(e){console.error(e)}},initTextarea=(t=null)=>{try{let e=".acpt-textarea";t&&(e="#"+t);var a=$$(e);let i=a.next(".acpt-textarea-ch-counter");a.length&&i.length&&a.on("keyup",function(e){var e=e.target.value.length,t=i.find(".count"),a=parseInt(i.data("max"));e<parseInt(i.data("min"))||a<=e?(t.removeClass("warning"),t.addClass("danger")):a-5<=e?(t.removeClass("danger"),t.addClass("warning")):(t.removeClass("warning"),t.removeClass("danger")),t.text(e)})}catch(e){console.error(e)}},initImageSlider=(e=null)=>{let t=".acpt-image-slider";e&&(t="#"+e);e=$$(t);e.length&&e.each(function(e){let t=$(this);t.find(".slider").on("input",function(e){t[0].style.setProperty("--position",e.target.value+"%")})})},initEmbed=(t=null)=>{try{let e=".acpt-embed";t&&(e="#"+t);var a=$$(e);if(a.length){let t=a.next(".embed-preview");a.on("keyup",debounce(e=>{e=e.target.value;""===e?t.html(""):$.ajax({type:"POST",url:ajaxurl,data:{action:"generateEmbedAction",data:JSON.stringify({value:e})},success:function(e){t&&t.html(`
                                <div class="embed">
                                    ${e.embed}
                                </div>
                            `)},error:function(e){t&&t.html("")},dataType:"json"})},1e3))}}catch(e){console.error(e)}},initBarcode=(t=null)=>{try{let e=".acpt-barcode-wrapper";t&&(e="#"+t);var a=$$(e);"function"==typeof JsBarcode&&a.length&&a.each(function(e){var t=$(this);let i=t.find(".value"),n=t.find(".format"),l=t.find(".color"),o=t.find(".bgColor");var a=t.find(".clear-barcode");let r=t.find(".acpt-barcode-svg"),c=t.find(".acpt-barcode-errors"),d=r.attr("id"),s=$("#barcode_value_"+d.replace("acpt-barcode-","")),p=()=>{r.html(`<svg class="acpt-barcode" id="${d}"></svg>`)},u=()=>{$("#acpt-"+d).removeClass("has-errors"),c.html("")},v=e=>{$("#acpt-"+d).addClass("has-errors"),c.html(e)},f=()=>{p(),i.val(""),n.val("code128"),l.val("#000"),o.val("#fff"),s.val("")};let m=()=>{try{u(),JsBarcode("#"+d,i.val(),{format:n.val()?n.val():"code128",background:o.val()?o.val():"#ffffff",lineColor:l.val()?l.val():"#000000"});var e={svg:(t=$("#"+d)[0].outerHTML,a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"},t.replace(/[&<>"']/g,function(e){return a[e]})),format:n.val()?n.val():"code128",bgColor:o.val()?o.val():"#ffffff",color:l.val()?l.val():"#000000"};s.val(JSON.stringify(e))}catch(e){f(),v(`The value "${i.val()}" is not valid for ${n.val()} format`)}var t,a};a.on("click",function(e){e.preventDefault(),f()}),i.on("keyup",debounce(e=>{m()},1e3)),n.on("change",function(e){m()}),l.on("acpt-icon-picker",debounce(e=>{m()},1e3)),o.on("acpt-icon-picker",debounce(e=>{m()},1e3))})}catch(e){console.error(e)}},initQRCodeGenerator=(t=null)=>{try{let e=".acpt-qr-code-wrapper";t&&(e="#"+t);var a=$$(e);"function"==typeof QRCode&&a.length&&a.each(function(e){var t=$(this);let a=t.find(".url"),i=t.find(".resolution"),n=t.find(".color-dark"),l=t.find(".color-light");var o=t.find(".clear-qr-code");let r=t.find(".acpt-qr-code"),c=r.attr("id"),d=$("#qr_code_value_"+c.replace("acpt-qr-code-","")),s=()=>{r.html("")},p=()=>{s(),a.val(""),i.val(100),n.val("#000"),l.val("#fff"),d.val("")},u=()=>a.is(":valid")&&""!==a.val(),v=()=>{var e;u()?(s(),e=document.getElementById(c),new QRCode(e,{text:a.val(),width:i.val(),height:i.val(),colorDark:n.val()?n.val():"#000000",colorLight:l.val()?l.val():"#ffffff",correctLevel:QRCode.CorrectLevel.H}),e={img:e.children[0].toDataURL("image/png"),resolution:i.val(),colorDark:n.val()?n.val():"#000000",colorLight:l.val()?l.val():"#ffffff"},d.val(JSON.stringify(e))):p()};o.on("click",function(e){e.preventDefault(),p()}),a.on("keyup",debounce(e=>{v()},1e3)),i.on("change",function(e){v()}),n.on("acpt-icon-picker",debounce(e=>{v()},1e3)),l.on("acpt-icon-picker",debounce(e=>{v()},1e3))})}catch(e){console.error(e)}},initValidator=()=>{if("function"==typeof ACPTFormValidator){let e=null;switch(adminpage){case"user-edit-php":case"edit-tags-php":e="add-tax";break;case"post-php":e="save-cpt";break;case"term-php":e="edit-tax";break;case"admin-php":e="save-option-page"}new ACPTFormValidator(e).run()}};function applyVisibilityFromLocalStorage(){var e=localStorage.getItem("acpt_fields_visibility");e&&JSON.parse(e).map(e=>{let l=$(`ul.acpt-sortable[data-conditional-rules-id="${e.id}"]`);e.vis.map((e,t)=>{var a,i,n,t=l.find("li")[t];t&&(a=t.id.includes("block-")?"collapsed":"hidden",i=t.querySelector(".li_toggle_visibility"),n=t.querySelector(".sortable-li_toggle_visibility"),!0===e?(i&&i.classList.remove("reverse"),n&&n.classList.remove("reverse"),t.classList.remove(a)):(i&&i.classList.add("reverse"),n&&n.classList.add("reverse"),t.classList.add(a)))})})}function handleGroupedElementEvents(){["acpt_grouped_element_removed","acpt_grouped_element_added","acpt_grouped_element_sorted","acpt_grouped_element_toggle_visibilty"].map(a=>{document.addEventListener(a,()=>{var e,t=$(".acpt-sortable");let o=[];t&&0<t.length&&("acpt_grouped_element_sorted"!==a&&"acpt_grouped_element_removed"!==a||0<(e=t.find(".acpt-id-value")).length&&e.each(function(e){var t=$(this).attr("id");"auto_inc"===$(`.acpt-id-generate[data-target-id=${t}]`).data("id-strategy")&&initIdGenerators(t,!0,e)}),t.each(function(e,t){var a=t.dataset.conditionalRulesId,i=t.querySelectorAll("li"),n=[];for(e=0;e<i.length;++e){var l=i[e],l=l.classList.contains("hidden")||l.classList.contains("collapsed");n.push(!l)}o.push({id:a,vis:n})})),localStorage.setItem("acpt_fields_visibility",JSON.stringify(o))})})}let initIdGenerators=(e=null,l=!1,o=null)=>{let t=".acpt-id-value";e&&(t="#"+e);e=$$(t);e.length&&e.each(function(e){let t=$(this);var a=t.attr("id"),a=$(`.acpt-id-generate[data-target-id=${a}]`);let i=a.data("id-strategy"),n=(null===o&&(o=a.data("index")),()=>{$.ajax({type:"POST",url:ajaxurl,data:{action:"generateIdAction",data:JSON.stringify({strategy:i,index:o})},success:function(e){e.id&&t.val(e.id)},dataType:"json"})});a.on("click",function(e){e.preventDefault(),e.stopPropagation(),n()}),l&&n()})};export{runMiscFunctions,initCodeMirror,initSelectize,initIntlTelInput,initCountrySelect,initTextarea,initImageSlider,initEmbed,initBarcode,initQRCodeGenerator,initValidator,applyVisibilityFromLocalStorage,handleGroupedElementEvents,initIdGenerators};