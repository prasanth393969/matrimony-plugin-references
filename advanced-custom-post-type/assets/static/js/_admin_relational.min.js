import{$$,useTranslation}from"./_admin_commons.min.js";import{isUUID}from"./_admin_helpers.min.js";import{initSortable}from"./_admin_sortable.min.js";var $=jQuery.noConflict();let initRelationalFields=(t=null)=>{try{let e=".acpt-relation-field-selector";t&&(e="#"+t);var a=$$(e);a.length&&a.each(function(e){var t=$(this);let a=t.attr("id");var l=t.data("field-type"),i=t.data("to-type"),s=t.data("to-value"),n=t.data("post-type"),o=t.data("post-status"),d=t.data("post-taxonomy"),r=t.data("term-taxonomy"),p=t.data("user-role"),c=t.data("default-values"),h=t.data("layout");let v=t.find("#options_"+a),u=t.find("#selected_items_"+a),m=t.find(".search-input"),f="title_"+a;$.ajax({type:"POST",url:ajaxurl,data:{action:"generateRelationalFieldOptionsAction",data:JSON.stringify({id:a,fieldType:l,toType:i,toValue:s,postType:n,postStatus:o,postTaxonomy:d,termTaxonomy:r,userRole:p,defaultValues:c,layout:h,format:"html"})},success:function(e){m.attr("disabled",!1),v.html(e.fields.options),u.html(e.fields.selected),displayDeleteAllLink($("#"+f),a),initSortable()},dataType:"json"})})}catch(e){console.error(e)}},handleRelationalFieldsEvents=()=>{document.addEventListener("acpt_grouped_element_sorted",e=>{if(e.detail.elementId){var e=e.detail.elementId,t=e.replace("selected_items_",""),t=$(`#${t}.acpt-relation-field-selector`).find("input");let a=[];$("#"+e).find("li").each(function(e){var t=$(this).data("value");a.push(t)}),t[0].value=a.join(",")}}),$("body").on("change",".post-relationship",function(e){if(e.preventDefault(),0!==$("#inversedBy").length){let e=$(this).val();Array.isArray(e)&&(e=e.join(",")),$("#inversedBy").val(e)}}),$("body").on("click",".acpt-relation-field-selector .options .value",function(e){var t,a,l,i,s,n,o,d,r;e.preventDefault(),e.stopPropagation(),$(this).hasClass("disabled")||((e=$(this)).attr("id"),a=(t=e.parent()).attr("id").replace("options_",""),t.data("min"),l=t.data("max"),i="selected_items_"+a,s="title_"+a,n="values_"+a,o=e.data("value"),d=e.html(),l&&$("#"+i).children().length>=l)||((r=$("#"+n).val()?$("#"+n).val().split(","):[]).push(o),$("#"+n).val(r.join(",")),$("#"+i).append(`
            <li id="${a}" class="sortable-li sortable-li-${a} value" data-value="${o}">
                <div class="handle-placeholder">
                    <span class="handle">.<br/>.<br/>.</span> 
                    <span class="placeholder">${d}</span>
                </div> 
                <a class="delete" href="#">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                        <path d="M5 20a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V8h2V6h-4V4a2 2 0 0 0-2-2H9a2 2 0 0 0-2 2v2H3v2h2zM9 4h6v2H9zM8 8h9v12H7V8z"></path><path d="M9 10h2v8H9zm4 0h2v8h-2z"></path>
                    </svg>
                </a>
            </li>
        `),document.getElementById(n).dispatchEvent(new Event("change")),e.addClass("hidden"),e.addClass("selected"),displayDeleteAllLink($("#"+s),a),initSortable(),l<=r.length&&t.addClass("not-allowed"))}),$("body").on("click",".acpt-relation-field-selector .selected-items .delete",function(e){e.preventDefault(),e.stopPropagation();e=$(this);let t=e.parent().data("value");var a=e.parent().parent().attr("id").replace("selected_items_",""),l="values_"+a,i="title_"+a,s=$("#options_"+a);s&&s.removeClass("not-allowed");let n=$("#"+l).val().split(",");n=n.filter(e=>isUUID(e)?e!==t:parseInt(e)!==t),$("#"+l).val(n.join(",")),document.getElementById(l).dispatchEvent(new Event("change")),$("#"+e.parent().attr("id")).removeClass("hidden"),$("#"+e.parent().attr("id")).removeClass("selected"),e.parent().remove();s=$("#options_"+e.parent().attr("id")).find("#"+t);0<s.length&&(s.removeClass("hidden"),s.removeClass("selected")),displayDeleteAllLink($("#"+i),a)}),$("body").on("click",".acpt-relation-field-selector .delete-all",function(e){e.preventDefault(),e.stopPropagation();var e=$(this),t=e.attr("id"),e=($("#selected_items_"+t).find(".value").each(function(){$(this).remove()}),$("#options_"+t).find(".value").each(function(){$(this).removeClass("hidden"),$(this).removeClass("selected")}),$("#values_"+t).val(""),document.getElementById("values_"+t).dispatchEvent(new Event("change")),e.remove(),$("#options_"+t));e&&e.removeClass("not-allowed")}),$("body").on("keyup",".acpt-relation-field-selector .acpt-form-control",function(){var e=$(this);let t=e.val();e=e.attr("id").replace("search_","");$("#options_"+e).find(".value").each(function(){var e=`.*${t}.*`,e=new RegExp(e,"gi");$(this).hasClass("selected")||(e.test($(this).text())?$(this).removeClass("hidden"):$(this).addClass("hidden"))})})},displayDeleteAllLink=(e,t)=>{0<$("#selected_items_"+t).children().length&&0===e.find(".delete-all").length&&e.append(`<a href="#" id="${t}" class="delete-all">${useTranslation("Delete all")}</a>`)};export{initRelationalFields,handleRelationalFieldsEvents};