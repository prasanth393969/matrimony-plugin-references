import{dateFields,useTranslation}from"./_admin_commons.min.js";import{initSortable}from"./_admin_sortable.min.js";import{initColorPicker}from"./_admin_colorpicker.min.js";import{initDateRangePicker}from"./_admin_datepicker.min.js";import{initRelationalFields}from"./_admin_relational.min.js";import{initTinyMCE}from"./_admin_editor.min.js";import{initBarcode,initCodeMirror,initCountrySelect,initEmbed,initIdGenerators,initImageSlider,initIntlTelInput,initQRCodeGenerator,initSelectize,initTextarea,initValidator}from"./_admin_misc.min.js";var $=jQuery.noConflict();let handleRepeaterFieldsEvents=()=>{let f=t=>{0<t.length&&(t[0].scrollIntoView({behavior:"smooth"}),t.addClass("sortable-li-active"),t.find(".acpt-admin-meta-field-input").each(function(t,e){var a=$(this),i=a.prop("tagName");if("INPUT"===i&&"hidden"!==a.attr("type"))return a.focus(),!1}))};document.addEventListener("keydown",a=>{if(a.ctrlKey&&"ArrowUp"===a.key&&a.target.classList.contains("acpt-admin-meta-field-input")){a.stopPropagation(),a.preventDefault();var i=$(a.target);let t=i.closest("li"),e=t.prev("li");0===e.length&&(t=i.closest("tr"),e=t.prev("tr")),0<e.length&&(t.removeClass("sortable-li-active"),f(e))}if(a.ctrlKey&&"ArrowDown"===a.key&&a.target.classList.contains("acpt-admin-meta-field-input")){a.stopPropagation(),a.preventDefault();i=$(a.target);let t=i.closest("li"),e=t.next("li");0===e.length&&(t=i.closest("tr"),e=t.next("tr")),0<e.length&&(t.removeClass("sortable-li-active"),f(e))}if(a.ctrlKey&&"Delete"===a.key&&a.target.classList.contains("acpt-admin-meta-field-input")){a.stopPropagation(),a.preventDefault();var i=$(a.target);let t=i.closest("tr");0<(t=0===t.length?i.closest("li"):t).length&&0<(i=t.find("a.remove-grouped-element")).length&&i.click()}if(a.ctrlKey&&"Enter"===a.key&&a.target.classList.contains("acpt-admin-meta-field-input")){a.stopPropagation(),a.preventDefault();i=$(a.target);let e=i.closest("ul");if(0<(e=0===e.length?i.closest("table"):e).length){let t=e.next(".add-grouped-element");0<(t=0===t.length?e.parent().next(".add-grouped-element"):t).length&&t.click()}}}),$(document).on("click",function(t){0===$(t.target).closest(".sortable-li-active").length&&(t=$(".sortable-li-active"))&&t.each(function(){$(this).removeClass("sortable-li-active")})}),$("body").on("click",".remove-all-grouped-elements",function(t){t.preventDefault();var t=$(this),e=t.data("layout"),a=t.data("element"),i=(t.data("elements"),t.data("groupId")),i=$(`.add-grouped-element[data-group-id=${i}]`);let n;var l=(n="table"===e?t.prev("a").prev(".acpt-table-responsive").find(".acpt-table").find(".acpt-sortable"):t.prev("a").prev(".acpt-sortable")).data("max-blocks"),r=n.attr("id"),t=t.data("group-id"),d=n.find("tr").children.length;n&&(t=`<p data-message-id="${t}" class="update-nag notice notice-warning inline no-records">${useTranslation(`No fields saved, generate the first one clicking on "Add ${a}" button`)}</p>`,"table"===e?(n.children("tr").each(function(t,e){0<t&&e.remove()}),a=d+2,$("#"+r).append(`<tr><td colspan="${a}">${t}</td></tr>`)):(n.empty(),$("#"+r).html("").append(t)),l)&&0<l&&i.removeAttr("disabled")}),$("body").on("click",".add-grouped-element",function(t){t.preventDefault();let a=$(this);t=a.data("group-id");let i=a.data("layout");var e=a.data("media-type"),n=a.data("parent-index"),l=a.data("parent-name");let r=$('[data-message-id="'+t+'"]'),d,o=0;o=("table"===i?(d=a.prev(".acpt-table-responsive").find(".acpt-table").find(".acpt-sortable").first()).find("tr.sortable-li"):(d=a.prev("ul.acpt-sortable")).find("li")).length;d.data("min-blocks");let s=d.data("max-blocks"),c=()=>void 0===s||d.find(".sortable-li").length<s;c()&&$.ajax({type:"POST",url:ajaxurl,data:{action:"generateGroupedFieldsAction",data:JSON.stringify({id:t,mediaType:e,index:o,parentName:l,parentIndex:n})},success:function(e){if(d){d.append(e.fields),initSortable(),initValidator(),c()?a.removeAttr("disabled"):a.attr("disabled","disabled");let t=d.find("li").last();0===t.length&&(t=d.find("tr").last()),f(t);{e=new Event("acpt_grouped_element_added"),e=(document.dispatchEvent(e),r&&("table"===i?r.parent("td").parent("tr"):r).remove(),d.last().find(".acpt-relation-field-selector")),e=(e.each(function(){initRelationalFields($(this).attr("id"))}),dateFields.map(t=>{d.last().find(t.selector).each(function(){initDateRangePicker(t.format,$(this).attr("id"))})}),d.last().find("textarea.acpt-codemirror"));e.each(function(){initCodeMirror($(this).attr("id"))})}d.last().find(".acpt-color-picker").each(function(){initColorPicker($(this).attr("id"))}),d.last().find("select.acpt-select2").each(function(){initSelectize($(this).attr("id"))}),d.last().find("textarea.acpt-wp-editor").each(function(){var t=$(this).attr("id"),e=$(this).attr("rows"),a=$(this).data("toolbar");initTinyMCE(t,e,a)}),d.last().find("input.acpt-id-value").each(function(){initIdGenerators($(this).attr("id"),!0)}),d.last().find("input.acpt-phone").each(function(){initIntlTelInput($(this).attr("id"))}),d.last().find("input.acpt-country").each(function(){initCountrySelect($(this).attr("id"))}),d.last().find(".acpt-qr-code-wrapper").each(function(){initQRCodeGenerator($(this).attr("id"))}),d.last().find(".acpt-barcode-wrapper").each(function(){initBarcode($(this).attr("id"))}),d.last().find(".acpt-image-slider").each(function(){initImageSlider($(this).attr("id"))}),d.last().find(".acpt-embed").each(function(){initEmbed($(this).attr("id"))}),d.last().find(".acpt-textarea").each(function(){initTextarea($(this).attr("id"))})}},dataType:"json"})}),$("body").on("click","a.remove-grouped-element",function(e){e.preventDefault();var e=$(this),t=e.data("parent-id"),a=e.data("target-id"),i=e.data("layout"),n=e.data("element"),e=(e.data("elements"),e.data("index")),a=$("#"+a),l=a.children.length;let r=a.parent();var d=r.attr("id");r.data("min-blocks");let o=r.data("max-blocks"),s=$(`.add-grouped-element[data-group-id=${t}]`),c=()=>void 0===o||r.find(".sortable-li ").length<o;if(a.remove(),c()?s.removeAttr("disabled"):s.attr("disabled","disabled"),0<r.length){let t=r.find("li");0<(t=0===t.length?r.find("tr"):t).length&&(a=t.get(e-1),e=$(a),f(e))}let p;0===(p="table"===i?r.find("tr").length-1:r.find("li").length)&&(a=`<p data-message-id="${t}" class="update-nag notice notice-warning inline no-records">${useTranslation(`No fields saved, generate the first one clicking on "Add ${n}" button`)}</p>`,"table"===i?(e=l+2,$("#"+d).append(`<tr><td colspan="${e}">${a}</td></tr>`)):$("#"+d).html("").append(a));t=new Event("acpt_grouped_element_removed");document.dispatchEvent(t)}),$("body").on("click",".sortable-li_toggle_visibility",function(t){t.preventDefault();var t=$(this),e=t.data("target-id"),e=$("#"+e),t=(t.hasClass("reverse")?t.removeClass("reverse"):t.addClass("reverse"),e.hasClass("hidden")?e.removeClass("hidden"):e.addClass("hidden"),new Event("acpt_grouped_element_toggle_visibilty"));document.dispatchEvent(t)}),$("body").on("mousedown",".sortable-li",function(){var t=$(this);t.attr("class").includes("sortable-li-active")||0<t.find(".sortable-li-active").length||($(".sortable-li-active").each(function(){$(this).removeClass("sortable-li-active")}),t.addClass("sortable-li-active"))}),$("body").on("change",".acpt-leading-field",function(n){var t=$(this);let l=t.attr("type"),r="object"==typeof t.val()?t.val().join(", "):t.val();t.parents().each(function(){var t,e,a=$(this),i=a.attr("class");i&&i.includes("sortable-li")&&("checkbox"===l?(i=n.target.checked,e=(t=a.find(".sortable-li_collapsed_placeholder").find("span.value")).text().split(", ").filter(t=>""!==t),i?(e.push(r),t.text(e.join(", "))):t.text(e.filter(t=>t!==r).join(", "))):a.find(".sortable-li_collapsed_placeholder").find("span.value").text(r))})})};export{handleRepeaterFieldsEvents};